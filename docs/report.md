# 页面置换算法的调研及ZSWAP的实现

## 背景介绍

在虚拟内存系统中，页面置换是一个非常重要的问题。好的页面置换策略和实现可以极大的提高虚拟内存的性能。但由于程序行为具有极大的不确定性，设计出能适应于各种场景下的置换策略和支撑系统几乎是不可能完成的任务。

## 实验概述

这次课程设计主要分为两部分：

1. 页面置换策略的调查研究。主要目标是页面置换策略的数学模型，理论工作和真实系统上的例子，形成比较完整的调研报告。通过分析页面置换问题的理论模型，了解真实系统上的实现及深层次的考虑，加深对操作系统的了解和认识。
2. 对 zswap 的分析及在 rcore 上的实现。zswap 在页面换出时维护一个压缩后的缓存，从而减少磁盘的读写次数。这部分的实现需要同时涉及连续内存分配问题以及页面置换问题，可以将各个不同的内存分配及页面置换算法在 zswap 上进行测试，分析各个算法的性能。

## 期望成果

- 用于模拟页面置换策略的模拟器。支持编写测例、从文件读入访存序列，并测试各种算法的miss/hit/竞争比。
- 页面置换策略的调研报告。讨论过去对页面置换问题的研究，主要关心用于分析各种策略的数学模型。

- ZSWAP的分析文档。讨论ZSWAP如何保证高效、稳定，如何和操作系统的其他模块协同。

- 在ucore/rcore上实现ZSWAP。

## 前期工作

### 页面置换算法调研

#### 文献调研

- [1] Belady, L. A . A study of replacement algorithms for a virtual-storage computer[J]. IBM Systems Journal, 1966, 5(2):78-101. 首次完整介绍了页面置换问题的几种算法，提出了离线意义下的最优算法MIN，提出了使用在线算法缺页次数和MIN缺页次数的比来评价在线算法的优劣。 

- [2] Fiat A , Karp R M , Luby M , et al. Competitive paging algorithms[J]. Journal of Algorithms, 1991, 12(4):685-699. 利用竞争性分析的手段证明了随机标记算法是竞争比意义下几乎最优的算法。竞争比是在线算法开销和最优算法开销的比，通过引入竞争性分析的手段，对各种置换算法的细节有了初步的分析。在前期工作中已经通过阅读论文和查阅网上相关资料，在调研报告中完成了一些关键定理的证明。

- [3] Denning P J. Working Sets Past and Present[J]. IEEE Transactions on Software Engineering, 1980, 6(1): 64-84. 关于工作集模型和工作集置换算法的综述，完整介绍了工作集模型提出的前因后果，还未完成阅读。

- [4] Borodin A, Raghavan P, Irani S, et al. Competitive paging with locality of reference[J]. symposium on the theory of computing, 1991, 50(2): 249-259. 通过引入“访存图”的概念使得模型包含了访存的局部性，在新的模型上使用竞争性分析，得到了更加贴近实践经验的结论。

#### 实践工作

- 已经完成了基本的模拟页面置换算法的框架， 可以编写测例测试各种算法的性能，计划实现LIRS等较新的算法，使用简单测例和真实的访存序列进行测试。
- 粗略阅读了《深入理解Linux内核》中关于页面置换问题的讨论，计划在中期更加详细的了解Linux中的策略。

### ZSWAP的实现

#### 对连续内存分配问题的调研

##### 调研工作
调研工作分为两个部分，第一个部分是对离线情况下的最优情况进行分析，第二部分是对在线情况的算法进行分析。

即使是离线情况下，连续内存分配依然是一个极为困难的问题。最小化峰值利用率的方案求解可以被证明是 NP-Hard 的 [1]。但是 [1] 中对它是 NP-Hard 的证明较为复杂，因此我们提出了一种新的简洁而巧妙的证明方式。详细证明细节可见关于 Dynamic Memory Allocation 的报告。若采用近似策略，则存在近似比为 (2+𝜖) 的多项式算法 [2]。

在线的内存分配算法就更为困难了。因此一般都采用贪心或启发式的方法：
* Sequential-fit Methods：贪心策略，例如最先/最佳/最差匹配、循环匹配
* Buddy Methods：分块策略，例如Buddy System
* Segregated-storage Methods：启发式策略，例如Slab Allocator [3]

##### 相关文献

* [1] J. M. Robson. Storage allocation is np-hard. Information Processing Letters, 11(3):119–125, 1980.

* [2] Tobias Mömke and Andreas Wiese. A (2 + ε)-approximation algorithm for the storage allocation problem. 2015.

* [3] Jeff Bonwick et al. The slab allocator: An object-caching kernel memoryallocator. InUSENIXsummer, volume 16. Boston, MA, USA, 1994.

#### 对 zswap 前期了解
在页面换入的时候，I/O操作是阻塞进行的，因此当换入一个页的时候，从磁盘读取会占用很多的时间。但阻塞是时候CPU很可能会闲置，因此一种考虑就是利用CPU减少这部分的时间。

zswap 的思想就是维护一个 Cache，当一个页被换出时，尝试用压缩算法对其进行压缩，若压缩后小于一定阈值，则将压缩后的页面缓存在内存中的 Cache 中，当需要换入的时候直接从缓存中读取相应的页面即可。这样就减少了这一次磁盘读取的时间，变成了一次压缩和解压的时间。

在 Linux 中，这个阈值的常用取值是 $\frac{1}{2}$，于是占用内存至少除以 $2$。Cache 的空间通过 zsmalloc 内存分配器进行分配。

但是由于 Cache 的大小也有限，因此在 Cache 占用过大空间后，采用类似页面置换的方式选取不需要的再进一步换出到外部设备。

## 时间规划

### 页面置换算法调研

- 第一阶段，进一步完成文献调研和资料整理的工作。我们认为着眼于程序访问内存的模型是比较好的选择。目前认为比较好的工作有：

  - 工作集模型：主要的参考文献有[3]及其衍生工作。利用工作集这一概念表示程序的访存规律。

  - 访存图模型：程序的访存很可能依附于程序使用的数据结构。在非线性的数据结构上，局部性原理失效了，取而代之的是在图上的邻近。这一思想来源于早期调研中发现的[4]的工作。

- 第二阶段，在模拟环境中实现LIRS算法，并结合真实访存序列测试性能，分析其优势所在。

- - 实验环境：模拟环境已经基本完成实现。
  - 遇到的困难主要有：
    1. 如何采集真实程序访存数据
    2. 理解和实现LIRS

- 第三阶段，了解Linux中关于页面置换问题的实现，通过阅读相关文档了解Linux如何将页面置换和其他子系统结合，并将调研内容是实现在ZSWAP中。

### Zswap的实现

* 第一阶段，在 rcore 中实现 zswap 框架，保留好相应的接口，便于更换使用的压缩算法、缓存中内存分配算法，及页面置换算法。
* 第二阶段，尝试将各个算法实现到 zswap 中，比较各个算法的性能。
* 第三阶段，对 zswap 可能对系统带来的性能提升/下降做测试及相应的分析。
* 第四阶段(可选)，尝试采用类似进程优先级的思想，为每个进程分配一个被缓存的优先级，优先保证减少重要进程的换出频率。
